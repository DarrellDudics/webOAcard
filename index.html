<!DOCTYPE html>
<html lang="en">

<head>
    <title>OA Card</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
   
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/webOAcard.css" rel="stylesheet">
    <style>


    </style>
</head>

<body>
 
    <div id="container" style="z-index: 1; position: absolute; left:0px; top:0px"></div>


    <div id="imgContainer" style="">
        <img style="">
        <a href="" download="card.png" style="">download</a>
    </div>

<div id="previewUI" style=" ">
    <div id="container2D" style="opacity:0.5; overflow:hidden;  width:100%;; height:100%;"></div>
    <a href="javascript:void(0)" id="download2D" style="">
    <i class="fa fa-arrow-circle-o-down fa-2x"></i>
     </a>
</div>
    
    <script src="js/three.min.js"></script>
    <script src="js/stats.min.js"></script>
    <script src="js/Detector.js"></script>
 
    <script src="js/jquery-1.9.1.js"></script>


    <script src="js/underscore-min.js"></script>
    
    <script src="js/jquery.mousewheel.min.js"></script>
    <script src="js/OrbitControls.js"></script>

    <script src="js/Javascript_Clipper_6.1.3.2/clipper.js"></script>
   
    <script src="js/oa.core.js"></script>
    <script src="js/oa.model.js"></script>
    <script src="js/oa.face.js"></script>
    <script src="js/oa.contour.js"></script>
    <script src="js/oa.clipper.js"></script>
    <script src="js/oa.point.js"></script>
    <script src="js/testFunctions.js"></script>
    <script>
    if (!Detector.webgl) Detector.addGetWebGLMessage();
    var debugMode = OA.debugMode;
    var camera, scene, renderer;
    var modelOption = {
        angle: 90,
        cardW: 120,
        cardH: 100,
        gridNum: 40
    };
    OA.Utils.texture.loadAllTexture(modelOption);

     var cardW = modelOption.cardW,
         cardH = modelOption.cardH;
     var maxWidth = cardW > cardH ? cardW : cardH;
     var gridStep = maxWidth / modelOption.gridNum;

    var oaModel = new OA.Model(modelOption);
    var sceneOffset = new THREE.Vector3(oaModel.getCardW() / 2, oaModel.getCardH() / 3, 0);

    var viewerR = maxWidth * 2.5;
    var mouse2D = new THREE.Vector3(0, 10000, 0.5);
    var orbitCtrls;
    var raycaster, projector;
    var cardModeOpts = [
        {name: "Edit", cameraControl: true, showEditPlane: true, angleFixed: 90},
        {name: "Display", cameraControl: true, showEditPlane: false, angleFixed: -1}];
        //,{name: "Print",cameraControl: false, editPlane: false, angleFixed: 180} 
 
    var cardMode = 0;
    var stats;
    //for preview
    var camera2, scene2, renderer2 , cam2, model2d;

    function init(oa) {
       

    //==preview===

    var $container2D = $("#container2D");
    var previewW = $container2D.width();
    var previewH = $container2D.height();
    var requestAnimationFrame2 = null;

    scene2 = new THREE.Scene();
    renderer2 = new THREE.WebGLRenderer({
        antialias: true
    });
    renderer2.setClearColor(0xeeeeee);
    $container2D.append(renderer2.domElement);
    cam2 = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000);
    //cam2 = new  THREE.OrthographicCamera( -previewH, previewW, previewH, -previewW, 1, 1000);
    cam2.position.set(0, viewerR, 0);
    scene2.position.x = cardW / 2;
    cam2.position.x = cardW / 2;
    cam2.lookAt(scene2.position);
    cam2.rotation.z = 0 * Math.PI / 180;

    cam2.aspect = previewW / previewH;
    cam2.updateProjectionMatrix();
    renderer2.setSize(previewW, previewH);
    $(oaModel).bind("facesClipped", function(){
        renderPreview();
    });
    renderPreview();
    //==========


        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 20000);
        //camera = new  THREE.OrthographicCamera( window.innerWidth / - 6, window.innerWidth / 6, window.innerHeight / 6, window.innerHeight / - 6, -1000, 1000);
        scene.add(camera);
        var fogNear = viewerR/18000;
        var fogFar = viewerR*2.2;
        //scene.fog=new THREE.FogExp2( 0xffffff, fogNear );
        scene.fog=new THREE.Fog( 0xffffff, fogNear, fogFar );

        camera.position.set(0, 0, oaModel.getCardH() * 2.5);

        if (Detector.webgl)
            renderer = new THREE.WebGLRenderer({
                antialias: true//,
                // precision: "highp",
                // preserveDrawingBuffer: true,
                // alpha: true
            });
        else
            renderer = new THREE.CanvasRenderer();

        renderer.setClearColor(new THREE.Color(0xEEEEEE, 1.0));
        renderer.setSize(window.innerWidth, window.innerHeight);



        if(OA.light){
            var ambientLight = new THREE.AmbientLight(0xFFE4C4);
            scene.add(ambientLight);
            var spotLight = new THREE.SpotLight( 0xffffff);
            spotLight.position.set( -viewerR*30, viewerR*25, viewerR*40);
            //spotLight.castShadow = true;
            scene.add( spotLight );

 
        }

        container = document.getElementById('container');
        container.appendChild(renderer.domElement);
        orbitCtrls = new THREE.OrbitControls(camera, renderer.domElement, container);
        orbitCtrls.noPan = true;
        orbitCtrls.panLeft(-sceneOffset.x);
        orbitCtrls.panUp(sceneOffset.y);
        orbitCtrls.maxPolarAngle = 120*Math.PI/180;
        orbitCtrls.rotateUp(10*Math.PI/180);
        orbitCtrls.rotateLeft(-10*Math.PI/180);
        orbitCtrls.zoomSpeed = 0.1;
        orbitCtrls.minDistance = oaModel.getCardH() * 2.5;
        oaModel.setCameraCtrl(orbitCtrls);
        //orbitCtrls.rotateLeft(-10*Math.PI/180);

        if (debugMode) {
            OA.Utils.debugaxis(scene, oa, 1000);
            stats = new Stats();
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.top = '0px';
            container.appendChild(stats.domElement);
        }


        scene.add(oaModel);

        projector = new THREE.Projector();
        //bind Event
        $(window).bind('resize', onWindowResize);
        $(window).bind("mousemove", onDocumentMouseMove);
        $(window).bind("mousedown", onDocumentMouseDown);


        changeCardMode(cardMode);
        // document.addEventListener('mousemove', onDocumentMouseMove, false);
        //document.addEventListener('mousedown', onDocumentMouseDown, false);
        // document.addEventListener('keydown', onDocumentKeyDown, false);
        // document.addEventListener('mousedown', onMouseDown, false);
        // document.addEventListener('keyup', onDocumentKeyUp, false);

        // //window.addEventListener('DOMMouseScroll', onMousewheel, false);
         //$(window).bind("mousewheel", onMousewheel);

 

        // $("#previewUI").click(function(e) {
        //     e.preventDefault();
        //     e.stopPropagation();
        //     return false;
        // });



        //download 2d pattern
        var $imgContainer = $("#imgContainer");
        var $downloadLink = $imgContainer.children("a");
        var $previewUI =  $("#previewUI");
        var $download2D = $("#download2D");

        $download2D.click(function(e) {
           var dataUrl = make2DImg(1000, 1000, previewW, previewH, $imgContainer, function(){
                 $downloadLink[0].click();

           });
           
        });

    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onDocumentMouseMove(event) {
        event.preventDefault();
        mouse2D.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse2D.y = -(event.clientY / window.innerHeight) * 2 + 1;
    }

    function changeCardMode(cardMode){
        var opt = cardModeOpts[cardMode];
        orbitCtrls.enabled = opt.cameraControl;
        oaModel.showEditPlane(opt.showEditPlane);

        if(opt.angleFixed === -1){
            oaModel.setFoldable(true);
        }else{
            oaModel.setFoldable(false);
            oaModel.resetCardAngle();
        }
    }

    function onDocumentMouseDown(event) {
        event.preventDefault();
        if (event.which == 3) {
            if(oaModel.contourState===0){
                cardMode = (cardMode + 1) % cardModeOpts.length;
                changeCardMode(cardMode);
            }
        }

        if (event.which == 2) {
             var angle = oaModel.getCardAngle();
             oaModel.setCardAngle(angle +10);
        }

    }



    function make2DImg(w, h, rendererW, rendererH, $imgContainer, callback) {

         renderer2.setSize(w, h);
         setTimeout(function(){
            //add timer for firefox issue: setSize and render immediately, browser will hang up 
            renderer2.render(scene2, cam2);
            var imgData;
            //var imgContainer =  $("#imgContainer");
            try {
                // renderer.setSize(window.innerWidth, window.innerHeight);
                imgData = toDataURL(renderer2); //renderer.domElement.toDataURL();
                // renderer.setSize(window.innerWidth, window.innerHeight);
                console.log(imgData);
            } catch (e) {
                console.log("Browser does not support taking screenshot of 3d context");
                return;
            }
            //imgContainer.show();
            var date = new Date();
            $imgContainer.children("img").attr("src", imgData);
            $imgContainer.children("a").attr("href", imgData)
            .attr("download", "oaCard_"+ date +".png");
            renderer2.setSize(rendererW, rendererH);
            setTimeout(function(){
                renderer2.render(scene2, cam2);
            }, 1);
            
            callback(imgData);

        }, 1);
        // _aspectResize(imgData, 1500, 1500, callback);
        // function callback(newImgData) {
        //     imgContainer.show();
        //     imgContainer.children("img").attr("src", newImgData);
        //     imgContainer.children("a").attr("href", newImgData);
        // }
    }


    function animate() {
        requestAnimationFrame(animate);
        render();
        if (stats!=undefined) {
            stats.update();
        }
        orbitCtrls.update();

       
    }
    function render() {
        raycaster = projector.pickingRay(mouse2D.clone(), camera);
        oaModel.tick({
            raycaster: raycaster
        });
        renderer.render(scene, camera);
    }


    init(oaModel);
    animate();


function renderPreview() {
    if (model2d != null) {
        scene2.remove(model2d);
    }
    model2d = oaModel.build2DPattern();
    scene2.add(model2d);
    renderer2.render(scene2, cam2);
}



// function animate2() {
//     renderPreview();
//     requestAnimationFrame2 = requestAnimationFrame(animate2);
//     renderer2.render(scene2, cam2);
// }

//  animate2();




//======================================



 

/*** ADDING SCREEN SHOT ABILITY ***/
window.addEventListener("keyup", function(e) {
    var imgData, imgNode;
    //Listen to 'P' key
    if (e.which == 80) { //p
        //  doPreview = true;
         make2DImg(1000, 1000, 250, 250, $("#imgContainer"));
    }

    if (e.which == 68) { //d undo
        //  doPreview = true;
        oaModel.undo();
    }

    if (e.which == 70) { //f redo
        //  doPreview = true;
        oaModel.redo();
    }



    if (e.which == 82) { //r
        //  oaModel.setCardAngle(180)
        // m2 = new OA.Model(modelOption)//oaModel.clone();
        // var cfs = oaModel.getCloneClippedFaces();
        // m2.setClippedFaces(cfs);
        // m2.updateModel(cfs);
        // m2.unbindEvents();

        // m2.setCardAngle(180)
        if (model2d != null) {
            scene2.remove(model2d)

        }
        model2d = oaModel.build2DPattern();
        scene2.add(model2d);

        renderer2.render(scene2, cam2);

        //oaModel.setCardAngle(90)
        //      m2.setCardAngle(180)

    }
    //  debugger;
    // imgNode = document.createElement("img");
    // imgNode.src = imgData;
    // document.body.appendChild(imgNode);
});












//========================================
        </script>

        
    </body>

    </html>
